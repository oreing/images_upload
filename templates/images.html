{% extends "base.html" %}

{% block title %}Image Gallery{% endblock %}

{% block content %}
<div class="jumbotron text-center">
    <h1 class="display-4">Image Gallery</h1>
    <p class="lead">Browse through the images uploaded by our community.</p>
    <hr class="my-4">
    <div class="action-row mb-4 text-right">
        <button class="btn batch-delete" onclick="confirmBatchDelete()">Batch Delete</button>
    </div>
    <div id="deleteMessage" class="mt-3"></div>
    <div class="row image-gallery">
        {% for image in images %}
        <div class="col-md-4 card-container" id="card-{{ image }}" onclick="selectCard('{{ image }}')">
            <div class="card mb-4">
                <img src="{{ url_for('send_image', filename=image) }}" class="card-img-top" alt="{{ image }}">
                <div class="card-body text-center">
                    <div class="card-title">{{ image }}</div>
                    <button class="btn select-btn">SELECT</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='images.css') }}">

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let selectedImages = [];

        function selectCard(imageName) {
            if (selectedImages.includes(imageName)) {
                selectedImages = selectedImages.filter(img => img !== imageName);
            } else {
                selectedImages.push(imageName);
            }
            updateDOM();
        }

        function updateDOM() {
            document.querySelectorAll('.card-container').forEach(card => {
                const imageName = card.id.replace('card-', '');
                if (selectedImages.includes(imageName)) {
                    card.classList.add('scale80');
                } else {
                    card.classList.remove('scale80');
                }
            });
        }

        document.getElementById('confirmDelete').onclick = function () {
            axios.delete('/delete_image', { data: { filenames: selectedImages } })
                .then(function (response) {
                    document.getElementById('deleteMessage').innerHTML = '<div class="alert alert-success">' + response.data.message + '</div>';
                    selectedImages.forEach(image => document.getElementById('card-' + image).remove());
                    selectedImages = [];
                    updateDOM();
                })
                .catch(function (error) {
                    document.getElementById('deleteMessage').innerHTML = '<div class="alert alert-danger">Error deleting image</div>';
                });
            $('#confirmModal').modal('hide');
        };

        window.selectCard = selectCard;

        function confirmBatchDelete() {
            if (selectedImages.length) {
                const imageList = document.getElementById('imageList');
                imageList.innerHTML = '';
                selectedImages.forEach(image => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = image;
                    imageList.appendChild(li);
                });
                $('#confirmModal').modal('show');
            }
        }

        window.confirmBatchDelete = confirmBatchDelete;
    });
</script>

{% include "confirm_modal.html" %}
{% endblock %}